<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GoX Hydration Test</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            color: #333;
        }

        #root {
            background: white;
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            min-width: 400px;
            text-align: center;
        }

        .counter-container {
            padding: 2rem;
        }

        .counter-container h1 {
            color: #333;
            margin-bottom: 2rem;
            font-size: 2.5rem;
        }

        .count-value {
            font-size: 5rem;
            font-weight: bold;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin: 2rem 0;
        }

        .counter-controls {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin-top: 2rem;
        }

        button {
            padding: 1rem 2rem;
            font-size: 1.1rem;
            border: none;
            border-radius: 0.5rem;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
        }

        .btn-danger {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
        }

        /* Hydration status indicator */
        .hydration-status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 20px;
            border-radius: 5px;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .hydration-status.pending {
            background: #ffc107;
            color: #000;
        }

        .hydration-status.success {
            background: #28a745;
            color: #fff;
        }

        .hydration-status.error {
            background: #dc3545;
            color: #fff;
        }
    </style>
</head>
<body>
    <!-- Hydration status indicator -->
    <div class="hydration-status pending">‚è≥ Server Rendered - Awaiting Hydration</div>

    <!-- Server-rendered content with hydration markers -->
    <div id="root" data-gox-component="counter-001">
        <div class="counter-container">
            <h1>GoX Counter (SSR)</h1>
            <div class="count-value" data-count="42">42</div>
            <div class="counter-controls">
                <button id="increment" data-action="increment">+ Increment</button>
                <button id="decrement" class="btn-secondary" data-action="decrement">- Decrement</button>
                <button id="reset" class="btn-danger" data-action="reset">Reset</button>
            </div>
        </div>
    </div>

    <!-- Hydration data embedded by server -->
    <script type="application/gox-hydration" data-component-id="counter-001">
    {
        "componentID": "counter-001",
        "componentName": "Counter",
        "props": {
            "initialCount": 42
        },
        "state": {
            "count": 42
        },
        "config": {
            "hydrate": true,
            "debug": true
        }
    }
    </script>

    <!-- WASM runtime -->
    <script src="../wasm/dist/wasm_exec.js"></script>

    <!-- Hydration script -->
    <script>
        // Hydration manager
        class HydrationManager {
            constructor() {
                this.status = document.querySelector('.hydration-status');
                this.hydrationData = null;
                this.component = null;
            }

            async init() {
                console.log('üåä Starting hydration process...');
                this.updateStatus('pending', '‚è≥ Loading WASM...');

                try {
                    // Extract hydration data
                    this.extractHydrationData();

                    // Load WASM component
                    await this.loadWASMComponent();

                    // Perform hydration
                    await this.hydrateComponent();

                    this.updateStatus('success', '‚úÖ Hydrated - Fully Interactive');
                    console.log('‚úÖ Hydration complete!');

                } catch (error) {
                    console.error('‚ùå Hydration failed:', error);
                    this.updateStatus('error', '‚ùå Hydration Failed - Using Static HTML');

                    // Fallback: Add basic interactivity without WASM
                    this.addFallbackHandlers();
                }
            }

            extractHydrationData() {
                const script = document.querySelector('script[type="application/gox-hydration"]');
                if (script) {
                    this.hydrationData = JSON.parse(script.textContent);
                    console.log('üì¶ Hydration data:', this.hydrationData);

                    // Remove script after extraction
                    script.remove();
                } else {
                    throw new Error('No hydration data found');
                }
            }

            async loadWASMComponent() {
                console.log('üîÑ Loading WASM module...');

                const go = new Go();
                const result = await WebAssembly.instantiateStreaming(
                    fetch('../wasm/dist/counter.wasm'),
                    go.importObject
                );

                // Run the Go program
                await go.run(result.instance);

                console.log('‚úÖ WASM module loaded');

                // Check if component is available
                const ComponentConstructor = window[this.hydrationData.componentName];
                if (!ComponentConstructor) {
                    throw new Error(`Component ${this.hydrationData.componentName} not found`);
                }

                // Create component with hydration props
                this.component = ComponentConstructor(this.hydrationData.props.initialCount);
            }

            async hydrateComponent() {
                const root = document.getElementById('root');

                console.log('üíß Hydrating component...');

                // Check if component supports hydration
                if (this.component.Hydrate) {
                    await this.component.Hydrate(root);
                    console.log('‚úÖ Component hydrated with existing DOM');
                } else {
                    // Fallback to client-side render
                    console.warn('‚ö†Ô∏è Component does not support hydration, falling back to CSR');
                    this.component.Render(root);
                }

                // Mark as hydrated
                root.setAttribute('data-gox-hydrated', 'true');
            }

            updateStatus(type, message) {
                this.status.className = `hydration-status ${type}`;
                this.status.textContent = message;
            }

            addFallbackHandlers() {
                // Basic fallback functionality without WASM
                const countEl = document.querySelector('.count-value');
                let count = parseInt(countEl.dataset.count || '0');

                document.getElementById('increment').addEventListener('click', () => {
                    count++;
                    countEl.textContent = count;
                    countEl.dataset.count = count;
                });

                document.getElementById('decrement').addEventListener('click', () => {
                    count--;
                    countEl.textContent = count;
                    countEl.dataset.count = count;
                });

                document.getElementById('reset').addEventListener('click', () => {
                    count = this.hydrationData?.props?.initialCount || 0;
                    countEl.textContent = count;
                    countEl.dataset.count = count;
                });

                console.log('üìå Added fallback handlers');
            }
        }

        // Initialize hydration when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                new HydrationManager().init();
            });
        } else {
            new HydrationManager().init();
        }

        // Performance monitoring
        if (window.performance) {
            window.addEventListener('load', () => {
                const perfData = performance.getEntriesByType('navigation')[0];
                console.log('‚ö° Performance metrics:');
                console.log(`  - DOM Content Loaded: ${Math.round(perfData.domContentLoadedEventEnd)}ms`);
                console.log(`  - Page Load: ${Math.round(perfData.loadEventEnd)}ms`);

                // Measure time to interactive
                requestAnimationFrame(() => {
                    console.log(`  - Time to Interactive: ${Math.round(performance.now())}ms`);
                });
            });
        }
    </script>
</body>
</html>